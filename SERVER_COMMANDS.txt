# Ù†ÙØ° Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± (pharmasky-server)
# Ø§Ù†Ø³Ø® ÙˆØ§Ù„ØµÙ‚ ÙÙŠ terminal

# =========================================
# Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 1: Ø­Ù„ Ø³Ø±ÙŠØ¹ (Ø¨Ø¯ÙˆÙ† git pull)
# =========================================

cd /opt/pharmasky

# Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù…Ø¨Ø§Ø´Ø±Ø©
cat > deploy_docker_fix.sh << 'SCRIPT_END'
#!/bin/bash

# PharmaSky Docker Fix Deployment Script
set -e

echo "ðŸš€ Starting PharmaSky Docker Fix Deployment..."
echo "================================================"

# Stop running containers
echo "Step 1: Stopping running containers..."
docker-compose down || true

# Remove old images
echo "Step 2: Removing old Docker images..."
docker rmi pharmasky_web pharmasky_celery pharmasky_celery_beat 2>/dev/null || true

# Clean Docker system
echo "Step 3: Cleaning Docker system..."
docker system prune -f

# Rebuild images with no cache
echo "Step 4: Rebuilding Docker images (this may take a few minutes)..."
docker-compose build --no-cache

# Start containers
echo "Step 5: Starting containers..."
docker-compose up -d

# Wait for services
echo "Step 6: Waiting for services to start..."
sleep 10

# Check status
echo "Step 7: Checking container status..."
docker-compose ps

# Test OpenAI
echo "Step 8: Testing OpenAI module..."
if docker exec pharmasky_web python -c "from openai import OpenAI; print('âœ… OpenAI loaded successfully!')" 2>/dev/null; then
    echo "âœ… OpenAI module is working!"
else
    echo "Installing OpenAI manually..."
    docker exec pharmasky_web pip install openai>=1.0.0
fi

# Show logs
echo "Step 9: Showing recent logs..."
docker-compose logs web --tail=30

echo ""
echo "================================================"
echo "âœ… Deployment completed!"
echo "================================================"
SCRIPT_END

# Ø¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªÙ†ÙÙŠØ°
chmod +x deploy_docker_fix.sh

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
./deploy_docker_fix.sh

# =========================================
# Ø£Ùˆ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 2: Ø­Ù„ ÙŠØ¯ÙˆÙŠ Ø³Ø±ÙŠØ¹
# =========================================
# Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ù…Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØŒ Ù†ÙØ° Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆØ§Ø­Ø¯Ø© ØªÙ„Ùˆ Ø§Ù„Ø£Ø®Ø±Ù‰:

docker-compose down
docker rmi pharmasky_web pharmasky_celery pharmasky_celery_beat 2>/dev/null || true
docker system prune -f
docker-compose build --no-cache
docker-compose up -d
sleep 10
docker-compose ps
docker-compose logs web --tail=50
docker exec pharmasky_web python -c "from openai import OpenAI; print('âœ… OK')"

