# دليل الغرامة والكاش باك
# Penalty & Cashback Guide

---

## 🎯 نظرة عامة

نظام الحوافز والغرامات يشجع الصيدليات على:
- ✅ **الدفع المبكر** ← كاش باك 0.10% يومياً
- ⚠️ **تجنب التأخير** ← غرامة 0.20% يومياً

---

## 💰 الغرامة (Late Payment Penalty)

### 🔴 متى تُطبق؟

عندما تتأخر الصيدلية عن موعد الدفع المحدد:
```
is_overdue = true
days_until_collection < 0
```

---

### 📐 كيف تُحسب؟

```
penalty_amount = outstanding_balance × penalty_percentage × late_days ÷ 100
```

**حيث:**
- `outstanding_balance` = المبلغ المستحق
- `penalty_percentage` = نسبة الغرامة اليومية (افتراضي: 0.20%)
- `late_days` = عدد أيام التأخير

---

### 📊 أمثلة عملية

#### مثال 1: تأخير يومين

```
المبلغ المستحق: 8,000 جنيه
نسبة الغرامة: 0.20% يومياً
عدد أيام التأخير: 2 يوم

الحساب:
penalty_amount = 8,000 × 0.20 × 2 ÷ 100
penalty_amount = 32 جنيه

الإجمالي المطلوب:
total_with_penalty = 8,000 + 32 = 8,032 جنيه
```

---

#### مثال 2: تأخير أسبوع

```
المبلغ المستحق: 15,000 جنيه
نسبة الغرامة: 0.20% يومياً
عدد أيام التأخير: 7 أيام

الحساب:
penalty_amount = 15,000 × 0.20 × 7 ÷ 100
penalty_amount = 210 جنيه

الإجمالي المطلوب:
total_with_penalty = 15,000 + 210 = 15,210 جنيه
```

---

#### مثال 3: تأخير شهر

```
المبلغ المستحق: 20,000 جنيه
نسبة الغرامة: 0.20% يومياً
عدد أيام التأخير: 30 يوم

الحساب:
penalty_amount = 20,000 × 0.20 × 30 ÷ 100
penalty_amount = 1,200 جنيه

الإجمالي المطلوب:
total_with_penalty = 20,000 + 1,200 = 21,200 جنيه
```

---

### 📈 جدول الغرامات

| أيام التأخير | غرامة على 10,000 ج | غرامة على 20,000 ج |
|--------------|-------------------|-------------------|
| 1 يوم | 20 ج | 40 ج |
| 2 يوم | 40 ج | 80 ج |
| 3 أيام | 60 ج | 120 ج |
| 7 أيام | 140 ج | 280 ج |
| 14 يوم | 280 ج | 560 ج |
| 30 يوم | 600 ج | 1,200 ج |

---

## 🎁 الكاش باك (Early Payment Cashback)

### 🟢 متى يُطبق؟

عندما تدفع الصيدلية قبل موعد الاستحقاق:
```
is_overdue = false
days_until_collection > 0
```

---

### 📐 كيف يُحسب؟

```
cashback_amount = outstanding_balance × cashback_percentage × early_days ÷ 100
```

**حيث:**
- `outstanding_balance` = المبلغ المستحق
- `cashback_percentage` = نسبة الكاش باك اليومية (افتراضي: 0.10%)
- `early_days` = عدد الأيام قبل الموعد

---

### 📊 أمثلة عملية

#### مثال 1: دفع قبل الموعد بـ 3 أيام

```
المبلغ المستحق: 10,000 جنيه
نسبة الكاش باك: 0.10% يومياً
عدد الأيام قبل الموعد: 3 أيام

الحساب:
cashback_amount = 10,000 × 0.10 × 3 ÷ 100
cashback_amount = 30 جنيه

المطلوب بعد الكاش باك:
total_with_cashback = 10,000 - 30 = 9,970 جنيه
```

---

#### مثال 2: دفع قبل الموعد بأسبوع

```
المبلغ المستحق: 15,000 جنيه
نسبة الكاش باك: 0.10% يومياً
عدد الأيام قبل الموعد: 7 أيام

الحساب:
cashback_amount = 15,000 × 0.10 × 7 ÷ 100
cashback_amount = 105 جنيه

المطلوب بعد الكاش باك:
total_with_cashback = 15,000 - 105 = 14,895 جنيه
```

---

#### مثال 3: دفع قبل الموعد بـ 10 أيام

```
المبلغ المستحق: 20,000 جنيه
نسبة الكاش باك: 0.10% يومياً
عدد الأيام قبل الموعد: 10 أيام

الحساب:
cashback_amount = 20,000 × 0.10 × 10 ÷ 100
cashback_amount = 200 جنيه

المطلوب بعد الكاش باك:
total_with_cashback = 20,000 - 200 = 19,800 جنيه
```

---

### 📈 جدول الكاش باك

| أيام قبل الموعد | كاش باك على 10,000 ج | كاش باك على 20,000 ج |
|----------------|---------------------|---------------------|
| 1 يوم | 10 ج | 20 ج |
| 2 يوم | 20 ج | 40 ج |
| 3 أيام | 30 ج | 60 ج |
| 5 أيام | 50 ج | 100 ج |
| 7 أيام | 70 ج | 140 ج |
| 10 أيام | 100 ج | 200 ج |

---

## ⚪ الدفع في الموعد

عندما تدفع الصيدلية في الموعد المحدد تماماً:
```
days_until_collection = 0
```

**لا توجد غرامة ولا كاش باك:**
```
penalty_amount = 0
cashback_amount = 0
total = outstanding_balance
```

---

## 🎯 مقارنة شاملة

### مثال: مبلغ مستحق 10,000 جنيه

| السيناريو | الأيام | الغرامة/الكاش باك | الإجمالي المطلوب |
|-----------|--------|-------------------|------------------|
| متأخر 7 أيام | -7 | غرامة: 140 ج | 10,140 ج |
| متأخر 3 أيام | -3 | غرامة: 60 ج | 10,060 ج |
| متأخر يوم واحد | -1 | غرامة: 20 ج | 10,020 ج |
| **في الموعد** | **0** | **لا شيء** | **10,000 ج** |
| مبكر يوم واحد | +1 | كاش باك: 10 ج | 9,990 ج |
| مبكر 3 أيام | +3 | كاش باك: 30 ج | 9,970 ج |
| مبكر 7 أيام | +7 | كاش باك: 70 ج | 9,930 ج |

---

## ⚙️ إعدادات النسب

### النسب الافتراضية

```python
late_payment_penalty_percentage = 0.20%  # غرامة التأخير
early_payment_cashback_percentage = 0.10%  # كاش باك الدفع المبكر
```

---

### تخصيص النسب لكل صيدلية

يمكن تعديل النسب من البروفايل:

**الحقول:**
- `late_payment_penalty_percentage`
- `early_payment_cashback_percentage`

**مثال:**
```python
# صيدلية VIP - نسب تحفيزية أفضل
pharmacy.profile.late_payment_penalty_percentage = 0.15  # غرامة أقل
pharmacy.profile.early_payment_cashback_percentage = 0.15  # كاش باك أعلى

# صيدلية عادية - النسب الافتراضية
pharmacy.profile.late_payment_penalty_percentage = 0.20
pharmacy.profile.early_payment_cashback_percentage = 0.10
```

---

## 📱 في الـ API

### الحصول على البيانات

```http
GET http://129.212.140.152/finance/collection-schedule/
```

**الاستجابة:**
```json
{
  "user_id": 7,
  "customer_name": "صيدلية الشفاء",
  "outstanding_balance": "8000.00",
  "days_until_collection": -2,
  "is_overdue": true,
  
  "penalty_percentage": "0.20",
  "penalty_amount": "32.00",
  "total_with_penalty": "8032.00",
  
  "cashback_percentage": "0.10",
  "cashback_amount": "0.00",
  "total_with_cashback": "8000.00"
}
```

---

## 🎨 عرض في الواجهة

### مثال 1: صيدلية متأخرة

```
═══════════════════════════════════════════
صيدلية الشفاء
═══════════════════════════════════════════

🔴 متأخر بـ 2 يوم

المبلغ الأصلي:    8,000 ج
غرامة التأخير:      +32 ج (0.20% × 2 يوم)
──────────────────────────
الإجمالي المطلوب: 8,032 ج
```

---

### مثال 2: صيدلية مبكرة

```
═══════════════════════════════════════════
صيدلية النور
═══════════════════════════════════════════

🟢 مبكر بـ 5 أيام

المبلغ الأصلي:    15,000 ج
كاش باك:             -75 ج (0.10% × 5 أيام)
──────────────────────────
الإجمالي المطلوب: 14,925 ج
```

---

## 📊 تقارير وإحصائيات

### إجمالي الغرامات

```python
total_penalties = sum([
    item['penalty_amount'] 
    for item in data['results'] 
    if item['is_overdue']
])
```

---

### إجمالي الكاش باك

```python
total_cashback = sum([
    item['cashback_amount'] 
    for item in data['results'] 
    if not item['is_overdue'] and item['days_until_collection'] > 0
])
```

---

### تقرير شهري

```
═══════════════════════════════════════════
      تقرير الغرامات والكاش باك
            شهر أكتوبر 2025
═══════════════════════════════════════════

الصيدليات المتأخرة:     8
إجمالي الغرامات:        520 ج

الصيدليات المبكرة:      15
إجمالي الكاش باك:       375 ج

صافي الفرق:            +145 ج
```

---

## 💡 نصائح للاستخدام

### 1. للصيدليات

```
✅ ادفع مبكراً → احصل على كاش باك
⚠️ تجنب التأخير → تجنب الغرامات
📅 الدفع في الموعد → لا غرامة ولا كاش باك
```

---

### 2. للإدارة

```
✅ راقب الصيدليات المتأخرة باستمرار
✅ حفّز الدفع المبكر بزيادة نسبة الكاش باك
✅ استخدم الغرامات كوسيلة رادعة
✅ كن مرناً مع الصيدليات المنتظمة
```

---

### 3. للمحاسبة

```
✅ سجل الغرامات بشكل منفصل
✅ سجل الكاش باك في الحسابات
✅ راجع التقارير شهرياً
✅ حلل أنماط الدفع
```

---

## 🔄 أمثلة كود

### Python

```python
# حساب الغرامة
def calculate_penalty(balance, days_late, rate=0.20):
    return (balance * rate * days_late) / 100

# حساب الكاش باك
def calculate_cashback(balance, days_early, rate=0.10):
    return (balance * rate * days_early) / 100

# مثال
balance = 10000
days_late = 5
penalty = calculate_penalty(balance, days_late)
print(f"Penalty: {penalty} ج")  # Output: 100.0 ج
```

---

### JavaScript

```javascript
// حساب الغرامة
function calculatePenalty(balance, daysLate, rate = 0.20) {
  return (balance * rate * daysLate) / 100;
}

// حساب الكاش باك
function calculateCashback(balance, daysEarly, rate = 0.10) {
  return (balance * rate * daysEarly) / 100;
}

// مثال
const balance = 10000;
const daysEarly = 7;
const cashback = calculateCashback(balance, daysEarly);
console.log(`Cashback: ${cashback} ج`);  // Output: 70 ج
```

---

## ✅ الخلاصة

### الغرامة (Penalty)

```
متى: عند التأخير (days_until_collection < 0)
كيف: 0.20% يومياً
مثال: 8,000 ج × 0.20% × 2 يوم = 32 ج
```

---

### الكاش باك (Cashback)

```
متى: عند الدفع المبكر (days_until_collection > 0)
كيف: 0.10% يومياً
مثال: 15,000 ج × 0.10% × 5 أيام = 75 ج
```

---

### الدفع في الموعد

```
متى: days_until_collection = 0
الحساب: لا غرامة ولا كاش باك
```

---

**آخر تحديث**: 2025-10-10  
**الإصدار**: 1.0.0  
**الحالة**: ✅ جاهز ويعمل

