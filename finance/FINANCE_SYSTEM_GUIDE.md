# دليل النظام المالي
# Finance System Guide

## 💰 الوظيفة الأساسية

النظام المالي يتتبع:
1. **الحسابات الجارية** لكل مستخدم (صيدلية/مورد)
2. **جميع المعاملات المالية** (فواتير، دفعات، مرتجعات)
3. **الأرصدة والديون** بشكل تلقائي

---

## 🏦 مكونات النظام

### 1️⃣ الحساب (Account)

**لكل مستخدم حساب يحتوي على:**

| الحقل | الوصف | مثال |
|-------|-------|------|
| `balance` | الرصيد الحالي | -15,000 |
| `credit_limit` | الحد الائتماني | 50,000 |
| `remaining_credit` | المتبقي من الائتمان | 35,000 |

**قراءة الرصيد:**
- `balance > 0` ✅ → عنده فلوس (رصيد موجب)
- `balance = 0` → متعادل
- `balance < 0` ⚠️ → **مديون** (رصيد سالب)

**مثال:**
```json
{
  "user": "صيدلية النور",
  "balance": -15000.00,         // مديونة 15,000 جنيه
  "credit_limit": 50000.00,     // مسموح لها تدين لحد 50,000
  "remaining_credit": 35000.00  // لسه ممكن تدين 35,000 زيادة
}
```

---

### 2️⃣ المعاملة المالية (AccountTransaction)

**كل عملية تُسجل معاملة:**

```python
{
  "account": "حساب صيدلية النور",
  "type": "PURCHASE_INVOICE",    # نوع المعاملة
  "amount": 20000,               # المبلغ
  "related_object": "فاتورة شراء رقم 5",  # مرتبطة بإيه
  "at": "2025-10-09"            # تاريخ المعاملة
}
```

---

### 3️⃣ دفعات الشراء (PurchasePayment)

**تسجيل دفعات للموردين:**

```json
{
  "user": "شركة الأدوية",
  "method": "cash",          // كاش، انستاباي، محفظة، منتجات
  "amount": 10000,
  "at": "2025-10-10",
  "remarks": "دفعة على الحساب"
}
```

---

### 4️⃣ دفعات البيع (SalePayment)

**تسجيل دفعات من الصيدليات:**

```json
{
  "user": "صيدلية النور",
  "method": "instapay",
  "amount": 5000,
  "at": "2025-10-10",
  "remarks": "تحصيل جزئي"
}
```

---

## 🔄 كيف تتأثر الأرصدة؟

### من وجهة نظر الشركة (أنت):

#### عمليات تزيد الرصيد ➕ (Positive)

| العملية | المبلغ | التأثير على الرصيد |
|---------|--------|---------------------|
| **Purchase Invoice** | 20,000 | `balance += 20,000` ❌ (تدين للمورد) |
| **Sale Payment** | 5,000 | `balance += 5,000` ✅ (صيدلية دفعت لك) |
| **Sale Return** | 2,000 | `balance += 2,000` ❌ (ترجع فلوس للصيدلية) |

#### عمليات تقلل الرصيد ➖ (Negative)

| العملية | المبلغ | التأثير على الرصيد |
|---------|--------|---------------------|
| **Sale Invoice** | 8,000 | `balance -= 8,000` ✅ (الصيدلية مديونة) |
| **Purchase Payment** | 10,000 | `balance -= 10,000` ✅ (دفعت للمورد) |
| **Purchase Return** | 1,000 | `balance -= 1,000` ✅ (رجعت بضاعة للمورد) |

---

## 📈 مثال عملي شامل: حساب صيدلية

### اليوم 1: بداية الشهر
```
balance = 0
credit_limit = 50,000
```

### اليوم 2: الصيدلية اشترت منك بضاعة
```
فاتورة بيع: 20,000 جنيه
معاملة: SALE_INVOICE (NEGATIVE)
balance = 0 - 20,000 = -20,000

👉 الصيدلية مديونة لك 20,000 جنيه
```

### اليوم 3: الصيدلية دفعت جزء
```
دفعة بيع: 8,000 جنيه
معاملة: SALE_PAYMENT (POSITIVE)
balance = -20,000 + 8,000 = -12,000

👉 الصيدلية لسه مديونة 12,000 جنيه
```

### اليوم 4: الصيدلية اشترت تاني
```
فاتورة بيع: 5,000 جنيه
معاملة: SALE_INVOICE (NEGATIVE)
balance = -12,000 - 5,000 = -17,000

👉 الصيدلية مديونة 17,000 جنيه
```

### اليوم 5: الصيدلية رجعت بضاعة معيبة
```
مرتجع بيع: 2,000 جنيه
معاملة: SALE_RETURN (POSITIVE)
balance = -17,000 + 2,000 = -15,000

👉 الصيدلية مديونة 15,000 جنيه
```

---

## 🎯 الحد الائتماني (Credit Limit)

```python
credit_limit = 50,000       # الحد الأقصى للدين
balance = -15,000          # الدين الحالي
remaining_credit = 50,000 + (-15,000) = 35,000

👉 الصيدلية لسه ممكن تدين 35,000 جنيه زيادة
```

**لو حاولت تبيع أكتر من remaining_credit:**
```
لو بعت بـ 40,000 جنيه → ❌ يرفض!
لأن: 40,000 > 35,000 (remaining_credit)
```

---

## 💵 طرق الدفع (Payment Methods)

| الطريقة | الكود |
|---------|-------|
| **كاش** | `cash` |
| **انستاباي** | `instapay` |
| **محفظة** | `wallet` |
| **منتجات** | `product` (مقايضة) |

---

## 📊 تقارير مالية

### عرض حساب صيدلية

```http
GET /finance/accounts/{id}/
```

```json
{
  "id": 5,
  "balance": "-15000.00",
  "credit_limit": "50000.00",
  "remaining_credit": "35000.00",
  "transactions_url": "/finance/account-transactions/?account=5"
}
```

### عرض معاملات الحساب

```http
GET /finance/account-transactions/?account=5
```

```json
{
  "results": [
    {
      "id": 10,
      "type": "SALE_INVOICE",
      "amount": "5000.00",
      "at": "2025-10-10",
      "related_object": "Sale Invoice #15"
    },
    {
      "id": 9,
      "type": "SALE_PAYMENT",
      "amount": "8000.00",
      "at": "2025-10-09"
    }
  ]
}
```

---

## 🔗 الربط التلقائي

### مع فواتير الشراء

```
إغلاق فاتورة شراء (10,000 جنيه)
    ↓
يُنشأ AccountTransaction تلقائياً
    type: PURCHASE_INVOICE
    amount: 10,000
    ↓
balance يزيد (الدين للمورد يزيد)
```

### مع فواتير البيع

```
إغلاق فاتورة بيع (8,000 جنيه)
    ↓
يُنشأ AccountTransaction تلقائياً
    type: SALE_INVOICE
    amount: 8,000
    ↓
balance يقل (دين الصيدلية يزيد)
```

### مع الدفعات

```
تسجيل دفعة من صيدلية (5,000 جنيه)
    ↓
يُنشأ SalePayment
    ↓
يُنشأ AccountTransaction تلقائياً
    type: SALE_PAYMENT
    amount: 5,000
    ↓
balance يزيد (دين الصيدلية يقل)
```

---

## 🎯 الخلاصة

| المكون | الوظيفة |
|--------|---------|
| **Account** | حساب جاري لكل مستخدم (الرصيد والحد الائتماني) |
| **AccountTransaction** | سجل كل معاملة مالية |
| **PurchasePayment** | دفعات للموردين |
| **SalePayment** | دفعات من الصيدليات |

**كل شيء تلقائي**:
- ✅ عند إغلاق فاتورة → تُسجل معاملة
- ✅ عند تسجيل دفعة → تُحدث الرصيد
- ✅ الحسابات تُنشأ تلقائياً

---

## 📱 APIs المتاحة

```
GET  /finance/accounts/                    قائمة الحسابات
GET  /finance/accounts/{id}/               تفاصيل حساب
PUT  /finance/accounts/{id}/change/        تعديل حد ائتماني

GET  /finance/account-transactions/        المعاملات المالية
GET  /finance/purchase-payments/           دفعات الشراء
POST /finance/purchase-payments/create/    تسجيل دفعة شراء
GET  /finance/sale-payments/               دفعات البيع
POST /finance/sale-payments/create/        تسجيل دفعة بيع
```

---

**ببساطة**: نظام المالية هو **"دفتر الحسابات الإلكتروني"** اللي بيتتبع كل فلس دخل أو خرج! 💰✨

**آخر تحديث**: 2025-10-10

