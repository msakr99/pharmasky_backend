# ุญู ุฎุทุฃ 500 ุนูุฏ ุฅุบูุงู ูุงุชูุฑุฉ ุงูุดุฑุงุก
# Troubleshooting 500 Error When Closing Purchase Invoice

## ๐ด ุงูุฎุทุฃ | Error

```
PUT /invoices/purchase-invoices/1/change-state/
{
  "supplier_invoice_number": "4601",
  "status": "closed"
}

Response: 500 Internal Server Error
```

---

## ๐ ุงูุฃุณุจุงุจ ุงููุญุชููุฉ | Possible Causes

### ุงูุณุจุจ 1: ุงูุฎุงุฏู ูู ูุชู ุชุญุฏูุซู โญ ุงูุฃูุซุฑ ุงุญุชูุงูุงู

**ุงููุดููุฉ**: ุงูุชุบููุฑุงุช ูู ุงูููุฏ ููุฌูุฏุฉ ูุญููุงู ููุทุ ููู ูุชู ุชุทุจูููุง ุนูู ุงูุฎุงุฏู ุงูุจุนูุฏ.

**ุงูุชุญูู**:
```bash
# ุงุฎุชุจุฑ ุฅุฐุง ูุงูุช ุงูุญููู ุงูุฌุฏูุฏุฉ ููุฌูุฏุฉ
GET http://129.212.140.152/invoices/purchase-invoices/1/

# ุฅุฐุง ูู ุชุฑู ูุฐู ุงูุญูููุ ูุงูุฎุงุฏู ุบูุฑ ูุญุฏุซ:
# - total_public_price
# - average_purchase_discount_percentage
```

**ุงูุญู**:
1. ุงุฑูุน ุงููููุงุช ุงููุนุฏูุฉ ุฅูู ุงูุฎุงุฏู
2. ุฃุนุฏ ุชุดุบูู Django
3. ุฑุงุฌุน [DEPLOYMENT_STEPS.md](./DEPLOYMENT_STEPS.md)

---

### ุงูุณุจุจ 2: ุนูุงุตุฑ ุงููุงุชูุฑุฉ ุบูุฑ ูุณุชููุฉ

**ุงููุดููุฉ**: ูุฌุจ ุฃู ุชููู ุฌููุน ุนูุงุตุฑ ุงููุงุชูุฑุฉ ูู ุญุงูุฉ `received` ูุจู ุงูุฅุบูุงู.

**ุงูุชุญูู**:
```bash
GET http://129.212.140.152/invoices/purchase-invoices/1/

# ุชุญูู ูู items:
{
  "items": [
    {
      "id": 1,
      "status": "placed",  // โ ููุณุช received
      ...
    }
  ]
}
```

**ุงูุญู**:
```bash
# ุญุฏุซ ุญุงูุฉ ูู ุนูุตุฑ
PUT http://129.212.140.152/invoices/purchase-invoice-items/1/change-state/
{
  "status": "received"
}

# ุซู ุญุงูู ุฅุบูุงู ุงููุงุชูุฑุฉ ูุฑุฉ ุฃุฎุฑู
```

---

### ุงูุณุจุจ 3: ุงููุงุชูุฑุฉ ูุงุฑุบุฉ (ุจุฏูู ุนูุงุตุฑ)

**ุงููุดููุฉ**: ุงููุงุชูุฑุฉ ูุง ุชุญุชูู ุนูู ุฃู ุนูุงุตุฑ.

**ุงูุชุญูู**:
```bash
GET http://129.212.140.152/invoices/purchase-invoices/1/

{
  "items_count": 0,
  "items": []  // โ ูุงุฑุบุฉ
}
```

**ุงูุญู**:
```bash
# ุฃุถู ุนูุงุตุฑ ูููุงุชูุฑุฉ ุฃููุงู
POST http://129.212.140.152/invoices/purchase-invoice-items/create/
{
  "invoice": 1,
  "product": 10,
  "quantity": 100,
  "purchase_discount_percentage": 10.00,
  "selling_discount_percentage": 5.00
}
```

---

### ุงูุณุจุจ 4: ุงููุณุชุฎุฏู ููุณ ูุฏูู ุญุณุงุจ ูุงูู (ูุจู ุงูุฅุตูุงุญ)

**ุงููุดููุฉ**: ูุจู ุงูุฅุตูุงุญ ุงูุฃุฎูุฑุ ูุงู ุงููุธุงู ูุชุทูุจ ูุฌูุฏ ุญุณุงุจ ูุงูู ูููุณุชุฎุฏู.

**ุงูุชุญูู**:
```bash
# ุชุญูู ุฅุฐุง ูุงู ุงูุฅุตูุงุญ ูุทุจู
# ุฅุฐุง ูุงู ุงูุฎุงุฏู ูุญุฏุซุ ูุฐู ุงููุดููุฉ ูุญูููุฉ โ
```

**ุงูุญู**:
- โ **ุชู ุงูุฅุตูุงุญ!** ุงูุขู ูุชู ุฅูุดุงุก ุงูุญุณุงุจ ุชููุงุฆูุงู
- ููู ูุฌุจ ุชุญุฏูุซ ุงูุฎุงุฏู ุฃููุงู

---

### ุงูุณุจุจ 5: ุงููุงุชูุฑุฉ ูุบููุฉ ุจุงููุนู

**ุงููุดููุฉ**: ูุญุงููุฉ ุชุบููุฑ ุญุงูุฉ ูุงุชูุฑุฉ ูุบููุฉ.

**ุงูุชุญูู**:
```bash
GET http://129.212.140.152/invoices/purchase-invoices/1/

{
  "status": "closed"  // โ ูุบููุฉ ุจุงููุนู
}
```

**ุงูุญู**:
- ูุง ูููู ุชุนุฏูู ูุงุชูุฑุฉ ูุบููุฉ
- ุฅุฐุง ููุช ุจุญุงุฌุฉ ููุชุนุฏููุ ุงุณุชุฎุฏู ูุงุชูุฑุฉ ูุฑุชุฌุน

---

## ๐ ุฎุทูุงุช ุงูุญู ุฎุทูุฉ ุจุฎุทูุฉ | Step-by-Step Solution

### ุงูุฎุทูุฉ 1: ุชุญูู ูู ุญุงูุฉ ุงููุงุชูุฑุฉ

```bash
GET http://129.212.140.152/invoices/purchase-invoices/1/
```

**ุชุญูู ูู**:
- โ `items_count > 0` (ุงููุงุชูุฑุฉ ุชุญุชูู ุนูู ุนูุงุตุฑ)
- โ `status != "closed"` (ููุณุช ูุบููุฉ ุจุงููุนู)
- โ ุฌููุน `items[].status == "received"` (ุฌููุน ุงูุนูุงุตุฑ ูุณุชููุฉ)

### ุงูุฎุทูุฉ 2: ุญุฏุซ ุญุงูุฉ ุงูุนูุงุตุฑ ุฅุฐุง ูุฒู ุงูุฃูุฑ

```bash
# ููู ุนูุตุฑ ูู ุญุงูุฉ "placed" ุฃู "accepted"
PUT http://129.212.140.152/invoices/purchase-invoice-items/{item_id}/change-state/
{
  "status": "received"
}
```

### ุงูุฎุทูุฉ 3: ุชุฃูุฏ ูู ุชุญุฏูุซ ุงูุฎุงุฏู

```bash
# ุชุญูู ูู ูุฌูุฏ ุงูุญููู ุงูุฌุฏูุฏุฉ
GET http://129.212.140.152/invoices/purchase-invoices/1/

# ุฅุฐุง ูู ุชุฑู ูุฐู ุงูุญูููุ ุญุฏุซ ุงูุฎุงุฏู:
# - total_public_price
# - average_purchase_discount_percentage
```

### ุงูุฎุทูุฉ 4: ุฃุบูู ุงููุงุชูุฑุฉ

```bash
PUT http://129.212.140.152/invoices/purchase-invoices/1/change-state/
{
  "supplier_invoice_number": "4601",
  "status": "closed"
}
```

**ุงูุงุณุชุฌุงุจุฉ ุงููุชููุนุฉ**:
```json
{
  "supplier_invoice_number": "4601",
  "status": "closed",
  "status_label": "Closed"
}
```

---

## ๐๏ธ ุฃุฏูุงุช ุชุดุฎูุต | Diagnostic Tools

### ุณูุฑูุจุช Python ููุชุญูู

```python
import requests

BASE_URL = "http://129.212.140.152"
TOKEN = "your-token-here"
INVOICE_ID = 1

headers = {
    "Authorization": f"Token {TOKEN}",
    "Content-Type": "application/json"
}

# 1. ุงุญุตู ุนูู ุชูุงุตูู ุงููุงุชูุฑุฉ
response = requests.get(
    f"{BASE_URL}/invoices/purchase-invoices/{INVOICE_ID}/",
    headers=headers
)
invoice = response.json()

print("=== ุชูุงุตูู ุงููุงุชูุฑุฉ ===")
print(f"ุงูุญุงูุฉ: {invoice.get('status')}")
print(f"ุนุฏุฏ ุงูุนูุงุตุฑ: {invoice.get('items_count')}")
print(f"ุฑูู ุงูููุฑุฏ: {invoice.get('supplier_invoice_number', 'ูุงุฑุบ')}")

# 2. ุชุญูู ูู ุญุงูุฉ ุงูุนูุงุตุฑ
items = invoice.get('items', [])
pending_items = [item for item in items if item['status'] != 'received']

if pending_items:
    print(f"\nโ๏ธ ููุงู {len(pending_items)} ุนูุตุฑ ุบูุฑ ูุณุชูู:")
    for item in pending_items:
        print(f"  - ุงูุนูุตุฑ {item['id']}: {item['status']}")
    print("\nูุฌุจ ุชุญุฏูุซูุง ุฅูู 'received' ุฃููุงู!")
else:
    print("\nโ ุฌููุน ุงูุนูุงุตุฑ ูุณุชููุฉ")

# 3. ุชุญูู ูู ุงูุญููู ุงูุฌุฏูุฏุฉ (ููุชุฃูุฏ ูู ุชุญุฏูุซ ุงูุฎุงุฏู)
if 'total_public_price' in invoice:
    print("\nโ ุงูุฎุงุฏู ูุญุฏุซ (ุงูุญููู ุงูุฌุฏูุฏุฉ ููุฌูุฏุฉ)")
else:
    print("\nโ ุงูุฎุงุฏู ุบูุฑ ูุญุฏุซ! ูุฌุจ ุฑูุน ุงูุชุญุฏูุซุงุช")

# 4. ุญุงูู ุงูุฅุบูุงู
if invoice['status'] != 'closed' and not pending_items:
    print("\n๐ ูุญุงููุฉ ุฅุบูุงู ุงููุงุชูุฑุฉ...")
    response = requests.put(
        f"{BASE_URL}/invoices/purchase-invoices/{INVOICE_ID}/change-state/",
        headers=headers,
        json={
            "supplier_invoice_number": "4601",
            "status": "closed"
        }
    )
    
    if response.status_code == 200:
        print("โ ุชู ุฅุบูุงู ุงููุงุชูุฑุฉ ุจูุฌุงุญ!")
        print(response.json())
    else:
        print(f"โ ุฎุทุฃ {response.status_code}")
        print(response.text)
```

---

## ๐ ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ | If Problem Persists

### ุงูุญุต ุณุฌูุงุช ุงูุฎุงุฏู

```bash
# ุนูู ุงูุฎุงุฏู
tail -f /var/log/gunicorn/error.log

# ุฃู
journalctl -u gunicorn -f

# ุฃู
docker logs -f container_name
```

**ุงุจุญุซ ุนู**:
- `RelatedObjectDoesNotExist` โ ุงููุณุชุฎุฏู ููุณ ูุฏูู ุญุณุงุจ (ูุฌุจ ุชุญุฏูุซ ุงูููุฏ)
- `ValidationError: Cannot close invoice` โ ุนูุงุตุฑ ุบูุฑ ูุณุชููุฉ
- `DoesNotExist` โ ุงููุงุชูุฑุฉ ุฃู ุงูุนูุงุตุฑ ุบูุฑ ููุฌูุฏุฉ

### ุงุฎุชุจุฑ ูุญููุงู ุฃููุงู

```bash
cd E:\sky0\sky

# ุดุบู ุงูุฎุงุฏู ุงููุญูู
python manage.py runserver

# ุงุฎุชุจุฑ ููุณ ุงูุทูุจ ูุญููุงู
# ุฅุฐุง ูุฌุญ ูุญููุงู ููู ูุดู ุนูู ุงูุฎุงุฏู โ ูุดููุฉ ูู ุงููุดุฑ
# ุฅุฐุง ูุดู ูุญููุงู โ ูุดููุฉ ูู ุงูุจูุงูุงุช ุฃู ุงูููุทู
```

---

## โ ูุงุฆูุฉ ุงูุชุญูู ุงูููุงุฆูุฉ | Final Checklist

ูุจู ูุญุงููุฉ ุฅุบูุงู ุงููุงุชูุฑุฉุ ุชุฃูุฏ ูู:

- [ ] ุงูุฎุงุฏู ูุญุฏุซ ุจุขุฎุฑ ุงูุชุบููุฑุงุช
- [ ] ุชู ุฅุนุงุฏุฉ ุชุดุบูู Django
- [ ] ุงููุงุชูุฑุฉ ุชุญุชูู ุนูู ุนูุงุตุฑ (`items_count > 0`)
- [ ] ุฌููุน ุงูุนูุงุตุฑ ูู ุญุงูุฉ `received`
- [ ] ุงููุงุชูุฑุฉ ููุณุช ูุบููุฉ ุจุงููุนู (`status != "closed"`)
- [ ] ุฑูู ูุงุชูุฑุฉ ุงูููุฑุฏ ููุฌูุฏ (`supplier_invoice_number`)

ุฅุฐุง ุชุญููุช ูู ูู ุฐูู ููุง ุฒุงู ุงูุฎุทุฃ ููุฌูุฏุงูุ ุดุงุฑู ุณุฌู ุงูุฃุฎุทุงุก ูู ุงูุฎุงุฏู.

---

**ุขุฎุฑ ุชุญุฏูุซ**: 2025-10-10

